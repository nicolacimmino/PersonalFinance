
# General

The OpenBanking service is responsible for pulling transaction data from bank institutions, using OpenBanking, through GoGardless.

At this stage there is no interface to create requisitions on GoCardless. Requisitions (bank connections) will need to be established once manually (using Postman). 
Once the requisition is created it will be enough to add the GoCardless accounts ID to the `ob_accounts` table and the process will be able to sync.

**Note:** when the requsition validity expires (depending on your bank, usually 3 to 6 months), you will need to re-authorize using postman. Account IDs won't change.

# Setup

## Install and first run

You will need to:
* Create a GoCardless account and API key (start at: bankaccountdata.gocardless.com). **Note:** GoCardless core business is Payments Initiation and that API is not free. However they provide the "Bank Account Data" API which is free for up to 10 active requisitions (bank connection) in a given month, so make sure you start from bankaccountdata.gocardless.com and not gocardless.com.
* Create a Postgres empty database
* Install Rust
* Clone this repo and add a .env file in the `OpenBanking` folder with the following:

````
DATABASE_URL=postgresql://[user]:[password]@127.0.0.1:5432/[dbname]

GOCARDLESS_SECRET_ID=[your GoCardless API Secret]
GOCARDLESS_SECRET_KEY=[your GoCardless API Secret Key]
GOCARDLESS_HOST=https://bankaccountdata.gocardless.com
````

* Run the app once with `cargo run`

If all is setup correctly this will run the `diesel` migrations and you should have a db schema with `ob_accounts` and `ob_transactions` tables.

## Create a GoCardless requisition

You will need to manually create requisitions with GoCardless as this service does not provide any facility to go through the OpenBanking authorization flow.

*NOTE:* you cannot use the GoCardless web interface to do this, requisitions created that way are not available through the API.

### Get a GoCardless token

````
curl --location 'https://bankaccountdata.gocardless.com/api/v2/token/new/' \
--header 'Content-Type: application/json' \
--data '{
    "secret_id": "[your secret id]",
    "secret_key": "[your secret key]"
}'
````

Copy the `access` from the result and use it for the following requests.

### Find the institution ID

````
curl --location 'https://bankaccountdata.gocardless.com/api/v2/institutions/?country=fi' \
--header 'Accept: application/json' \
--header 'Authorization: Bearer [access token]'
````
Note: change the country code in the URL the one of your bank.

Find your bank and note its ID (eg `NORDEA_NDEAFIHH`).

### Create a requistion

````
curl --location 'https://bankaccountdata.gocardless.com/api/v2/requisitions/' \
--header 'Accept: application/json' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer [access token]' \
--data '{
    "redirect": "http://www.example.com",
    "institution_id": "NORDEA_NDEAFIHH",
    "reference": "Any unique string, not relevant here",
    "user_language": "EN"
}'
````
`redirect` and `reference` can be anything, they are needed only if you were building an actual service and would serve to redirect the user to your website at the end of the process.

In the response you will find an `id` field and a `link` field. **Write down the id** as there is no way to retrieve requisition IDs in GoCardless and you will need this later. Open the link in a browser and follow your bank OpenBanking login flow. Once you are redirected to "example.com" (or whatever you specified, it's irrelevant) the requisition is complete and you can test it.

## Get the GoCardless account IDs

````
curl --location 'https://bankaccountdata.gocardless.com/api/v2/requisitions/[requisition ID from above]/' \
--header 'Accept: application/json' \
--header 'Authorization: Bearer [access token]'
````

The response will contain one or more accounts (depending on how many you have with this institution and have autorized during the previos step). You will need these GoCardless accounts ID to be added to the database for the sync to work.

## Configure the accounts 

Connect to the Postgres db, open the `ob_accounts` table and add a new row for each account. Leave `id` empty as it will be autogenerated. Fill the other fields:

`provider` -> `GOCARDLESS`
`provider_account_id` -> The account ID from the previous step ("Get the GoCardless account IDs")

You are all set! Just run the app again with `cargo run` and it will fetch all available transactions and store them in `ob_transactions`. If you run the application again at a later date only new transactions will be added to the database.



`name` -> Just a friendly name for your reference e.g. "Checking account"





